<!doctype html><html lang=en-us><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge,chrome=1"><title>Using OpenFisca as an Expert System Engine | Jason Morris</title><meta name=viewport content="width=device-width,minimum-scale=1"><meta name=description content="At Service Canada we are working on a new tool to help Canadians to plan for retirement. And we are experimenting with implementing that…"><meta name=generator content="Hugo 0.94.1"><meta name=ROBOTS content="NOINDEX, NOFOLLOW"><link rel=stylesheet href=/ananke/css/main.min.css><meta property="og:title" content="Using OpenFisca as an Expert System Engine"><meta property="og:description" content="At Service Canada we are working on a new tool to help Canadians to plan for retirement. And we are experimenting with implementing that…"><meta property="og:type" content="article"><meta property="og:url" content="https://JasonMorrisSC.github.io/post/roundtablelaw/using-openfisca-as-an-expert-system-engine-e291ddc50815/"><meta property="article:section" content="post"><meta property="article:published_time" content="2021-12-08T19:29:44+00:00"><meta property="article:modified_time" content="2021-12-08T19:29:44+00:00"><meta itemprop=name content="Using OpenFisca as an Expert System Engine"><meta itemprop=description content="At Service Canada we are working on a new tool to help Canadians to plan for retirement. And we are experimenting with implementing that…"><meta itemprop=datePublished content="2021-12-08T19:29:44+00:00"><meta itemprop=dateModified content="2021-12-08T19:29:44+00:00"><meta itemprop=wordCount content="2501"><meta itemprop=keywords content><meta name=twitter:card content="summary"><meta name=twitter:title content="Using OpenFisca as an Expert System Engine"><meta name=twitter:description content="At Service Canada we are working on a new tool to help Canadians to plan for retirement. And we are experimenting with implementing that…"></head><body class="ma0 avenir bg-near-white"><header><div class=bg-black><nav class="pv3 ph3 ph4-ns" role=navigation><div class="flex-l justify-between items-center center"><a href=/ class="f3 fw2 hover-white no-underline white-90 dib">Jason Morris</a><div class="flex-l items-center"><ul class="pl0 mr3"><li class="list f5 f4-ns fw4 dib pr3"><a class="hover-white no-underline white-90" href=/about/ title="About Jason page">About Jason</a></li><li class="list f5 f4-ns fw4 dib pr3"><a class="hover-white no-underline white-90" href=/project/ title="Projects page">Projects</a></li><li class="list f5 f4-ns fw4 dib pr3"><a class="hover-white no-underline white-90" href=/post/ title="Rules as Code Diary page">Rules as Code Diary</a></li></ul><div class=ananke-socials><a href=https://twitter.com/RoundTableLaw target=_blank class="twitter ananke-social-link link-transition stackoverflow link dib z-999 pt3 pt0-l mr1" title="Twitter link" rel=noopener aria-label="follow on Twitter——Opens in a new window"><span class=icon><svg style="enable-background:new 0 0 67 67" viewBox="0 0 67 67" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M37.167 22.283c-2.619.953-4.274 3.411-4.086 6.101l.063 1.038-1.048-.127c-3.813-.487-7.145-2.139-9.974-4.915l-1.383-1.377-.356 1.017c-.754 2.267-.272 4.661 1.299 6.271.838.89.649 1.017-.796.487-.503-.169-.943-.296-.985-.233-.146.149.356 2.076.754 2.839.545 1.06 1.655 2.097 2.871 2.712l1.027.487-1.215.021c-1.173.0-1.215.021-1.089.467.419 1.377 2.074 2.839 3.918 3.475l1.299.444-1.131.678c-1.676.976-3.646 1.526-5.616 1.568C19.775 43.256 19 43.341 19 43.405c0 .211 2.557 1.397 4.044 1.864 4.463 1.377 9.765.783 13.746-1.568 2.829-1.673 5.657-5 6.978-8.221.713-1.716 1.425-4.851 1.425-6.354.0-.975.063-1.102 1.236-2.267.692-.678 1.341-1.419 1.467-1.631.21-.403.188-.403-.88-.043-1.781.636-2.033.551-1.152-.402.649-.678 1.425-1.907 1.425-2.267.0-.063-.314.042-.671.233-.377.212-1.215.53-1.844.72l-1.131.361-1.027-.7c-.566-.381-1.361-.805-1.781-.932C39.766 21.902 38.131 21.944 37.167 22.283zM33 64C16.432 64 3 50.569 3 34S16.432 4 33 4s30 13.431 30 30S49.568 64 33 64z" style="fill-rule:evenodd;clip-rule:evenodd;fill:{{ .fill }}"/></svg></span><span class=new-window><svg height="8" style="enable-background:new 0 0 1000 1000" viewBox="0 0 1e3 1e3" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M598 128h298v298h-86V274L392 692l-60-60 418-418H598v-86zM810 810V512h86v298c0 46-40 86-86 86H214c-48 0-86-40-86-86V214c0-46 38-86 86-86h298v86H214v596h596z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg></span></a></div></div></div></nav></div></header><main class=pb7 role=main><article class="flex-l flex-wrap justify-between mw8 center ph3"><header class="mt4 w-100"><aside class="instapaper_ignoref b helvetica tracked">RULES AS CODE DIARY</aside><div id=sharing class="mt3 ananke-socials"><a href="https://twitter.com/share?url=https://JasonMorrisSC.github.io/post/roundtablelaw/using-openfisca-as-an-expert-system-engine-e291ddc50815/&text=Using%20OpenFisca%20as%20an%20Expert%20System%20Engine" class="ananke-social-link twitter no-underline" aria-label="share on Twitter"><span class=icon><svg style="enable-background:new 0 0 67 67" viewBox="0 0 67 67" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M37.167 22.283c-2.619.953-4.274 3.411-4.086 6.101l.063 1.038-1.048-.127c-3.813-.487-7.145-2.139-9.974-4.915l-1.383-1.377-.356 1.017c-.754 2.267-.272 4.661 1.299 6.271.838.89.649 1.017-.796.487-.503-.169-.943-.296-.985-.233-.146.149.356 2.076.754 2.839.545 1.06 1.655 2.097 2.871 2.712l1.027.487-1.215.021c-1.173.0-1.215.021-1.089.467.419 1.377 2.074 2.839 3.918 3.475l1.299.444-1.131.678c-1.676.976-3.646 1.526-5.616 1.568C19.775 43.256 19 43.341 19 43.405c0 .211 2.557 1.397 4.044 1.864 4.463 1.377 9.765.783 13.746-1.568 2.829-1.673 5.657-5 6.978-8.221.713-1.716 1.425-4.851 1.425-6.354.0-.975.063-1.102 1.236-2.267.692-.678 1.341-1.419 1.467-1.631.21-.403.188-.403-.88-.043-1.781.636-2.033.551-1.152-.402.649-.678 1.425-1.907 1.425-2.267.0-.063-.314.042-.671.233-.377.212-1.215.53-1.844.72l-1.131.361-1.027-.7c-.566-.381-1.361-.805-1.781-.932C39.766 21.902 38.131 21.944 37.167 22.283zM33 64C16.432 64 3 50.569 3 34S16.432 4 33 4s30 13.431 30 30S49.568 64 33 64z" style="fill-rule:evenodd;clip-rule:evenodd;fill:{{ .fill }}"/></svg></span></a></div><h1 class="f1 athelas mt3 mb1">Using OpenFisca as an Expert System Engine</h1><time class="f6 mv4 dib tracked" datetime=2021-12-08T19:29:44Z>December 8, 2021</time></header><div class="nested-copy-line-height lh-copy serif f4 nested-links nested-img mid-gray pr4-l w-two-thirds-l"><p>At Service Canada we are working on a new tool to help Canadians to plan for retirement. And we are experimenting with implementing that system using a Rules as Code approach. Specifically, we are looking at implementing the rules in <a href=https://openfisca.org>OpenFisca</a>.</p><p>OpenFisca is a leading Rules as Code solution, but it is primarily aimed at microsimulation. Microsimulation is where you create a data model that represents small elements of a population, like people and households, and then encode the effects of different tax and benefit regimes. You can then load data that is representative of your actual population, and look at the effects on those individuals or groups in aggregate. Or, you can load a smaller number of specific examples and see how those particular fact scenarios are affected by the rules.</p><p>In either case, the expected workflow is that the information is provided at the beginning, and OpenFisca does a calculation, and returns the result.</p><p>An expert system, if you are using the term as it was used in the 80s and 90s, is a system that has a thing that is it trying to figure out, and can figure out what questions to ask based on the rules and the information that has already been provided. That process operates differently. It anticipates that the data will be given to the reasoner one piece at a time, and after each piece of data is given, the reasoner will advise whether it knows the answer to the question, and if not, what other questions are relevance.</p><h3 id=the-plan>The Plan</h3><p>In order to give OpenFisca something like that capability, my plan is to give OpenFisca the concept of uncertainty. By default, OpenFisca treats variables that it hasn’t been given as “false-ish”. Booleans will be false, integers will be zero, and strings will be blank, for example. That means that OpenFisca can’t really tell the difference between having been told that an input variable’s true value is zero, and not having been given a value.</p><p>In order to give OpenFisca the concept of uncertainty, I’m going to take the existing list of variables, and duplicate them, creating a separate boolean variable for whether or not the first variable is “known.” For input variables, the user will specify that the variable is known in the data submitted to OpenFisca.</p><p>Then, the user will be able to ask for the result they are interested in, and they will also be able to ask whether that result is known. If they use the <code>/trace</code> endpoint for the OpenFisca server, they will receive data that can be turned into a dependency tree, showing how each part of the calculation depended on other parts.</p><p>Then, if we break out the conclusions of all the logical operations into their own variables, so the conclusion of each “and”, “or”, or comparison becomes its own variable that may or may not be known, the dependency tree for whether or not the conclusion is “known” should have all the information we need to understand what questions are relevant.</p><p>If OpenFisca says that the root of that tree is “known”, then the question has been answered, and there are no more questions that need to be asked. Otherwise, all of the unknown leaf nodes that have only unknown nodes above them in the tree are still potentially relevant.</p><p>The resulting dependency trees will also be sufficient information from which to generate sophisticated user-facing explanations for the conclusions that are reached. I have a suspicion that they will actually contain considerably more information than a typical logical trace will provide, because it should be possible to determine if a conclusion might have been reached in more than one way based on the information provided.</p><h3 id=some-caveats>Some Caveats</h3><h4 id=structural-isomorpshim>Structural Isomorpshim</h4><p>I’m a big fan of what I call “structural isomorphism.” The smallest possible parts of your encoding should have as close as possible to a one-to-one relationship with the smallest possible parts of the law.</p><p>For this experiment, I’m ignoring structural isomorphism, at least to the extent that the sections of code should be small. This approach requires a lot of code. I don’t think it breaks the one-to-one relationship, but I’ll find that out later and let you know. It certainly breaks the requirement that the pieces of code be as small as possible.</p><h4 id=multiple-queries>Multiple Queries</h4><p>An acknowledged downside of this approach is that in order to get the information about whether the conclusion is known, or not, the user needs to send two queries to the OpenFisca API. One for the answer, and one for whether or not the answer is known. That’s less than elegant. There’s probably a way to solve that problem by having OpenFisca query itself, and then include the results in the response.</p><p>But we’re not there, yet.</p><h4 id=post-processing>Post-Processing</h4><p>Another acknowledged downside of this approach is that it requires the client accessing the OpenFisca Web API to do post-processing on the results that it receives from the two queries. It does not simply output a list of variable names that are still relevant. It provides data on which you can run an algorithm, which will reveal that list.</p><h4 id=style-dependent>Style Dependent</h4><p>Another acknowledged downside of this approach is that it does not work on all OpenFisca code. The code needs to have been written in this particular way for that algorithm to work, and the application developer needs to know that the code has been written that way. That breaks the separation of concerns. The application developer ought not need to know how the code was implemented in order to be able to access the useful information. But that’s a natural result of the fact that uncertainty and explanations are not features of OpenFisca. We’re just trying to use OpenFisca in such a way as to achieve a similar effect.</p><h3 id=an-example>An Example</h3><p>I’ll try to do this up as a Colab Notebook, so you can play along if you’re interested.</p><p>Let’s say we want to encode the rules for eligibility for the Guaranteed Income Supplement in OpenFisca. We might write a variable like this:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>gis_eligible</span>(Variable):  
</span></span><span style=display:flex><span>  value_type <span style=color:#f92672>=</span> bool  
</span></span><span style=display:flex><span>  entity <span style=color:#f92672>=</span> Person  
</span></span><span style=display:flex><span>  definition_period <span style=color:#f92672>=</span> DAY  
</span></span><span style=display:flex><span>  label <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;Whether Person is eligible for Guaranteed Income Supplement&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>formula</span>(person, period, parameters):  
</span></span><span style=display:flex><span>    married <span style=color:#f92672>=</span> person(<span style=color:#e6db74>&#39;marital_status&#39;</span>,period) <span style=color:#f92672>==</span> marital_status_options<span style=color:#f92672>.</span>MARRIED  
</span></span><span style=display:flex><span>    common_law <span style=color:#f92672>=</span> person(<span style=color:#e6db74>&#39;marital_status&#39;</span>,period) <span style=color:#f92672>==</span> marital_status_options<span style=color:#f92672>.</span>COMMONLAW  
</span></span><span style=display:flex><span>    partnered <span style=color:#f92672>=</span> married <span style=color:#f92672>+</span> common_law  
</span></span><span style=display:flex><span>    max_single <span style=color:#f92672>=</span> parameters(period)<span style=color:#f92672>.</span>benefits<span style=color:#f92672>.</span>old_age_security<span style=color:#f92672>.</span>guaranteed_income_supplement<span style=color:#f92672>.</span>maximum_income_single  
</span></span><span style=display:flex><span>    max_partner <span style=color:#f92672>=</span> parameters(period)<span style=color:#f92672>.</span>benefits<span style=color:#f92672>.</span>old_age_security<span style=color:#f92672>.</span>guaranteed_income_supplement<span style=color:#f92672>.</span>maximum_income_partnered  
</span></span><span style=display:flex><span>    max_both <span style=color:#f92672>=</span> parameters(period)<span style=color:#f92672>.</span>benefits<span style=color:#f92672>.</span>old_age_security<span style=color:#f92672>.</span>guaranteed_income_supplement<span style=color:#f92672>.</span>maximum_income_two_recipients
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>max_income <span style=color:#f92672>=</span> where(partnered,max_partner,max_single)  
</span></span><span style=display:flex><span>    max_income <span style=color:#f92672>=</span> where(person(<span style=color:#e6db74>&#34;partner_receiving_oas&#34;</span>,period),max_both,max_income)  
</span></span><span style=display:flex><span>    income_requirement <span style=color:#f92672>=</span> person(<span style=color:#e6db74>&#34;income&#34;</span>,period<span style=color:#f92672>.</span>this_year) <span style=color:#f92672>&lt;</span> max_income  
</span></span><span style=display:flex><span>    age_requirement <span style=color:#f92672>=</span> person(<span style=color:#e6db74>&#34;age&#34;</span>,period) <span style=color:#f92672>&gt;=</span> parameters(period)<span style=color:#f92672>.</span>benefits<span style=color:#f92672>.</span>old_age_security<span style=color:#f92672>.</span>eligibility_age
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>return</span> person(<span style=color:#e6db74>&#39;oas_eligible&#39;</span>,period) <span style=color:#f92672>*</span> income_requirement <span style=color:#f92672>*</span> age_requirement
</span></span></code></pre></div><p>In pseudo code, the <code>formula</code> function reads “a person is partnered if they are married or common law. The person’s maximum income depends on if they are sincle, and if their partner is receiving oas. If they are eligible for OAS, and they have less than the maximum income, and are at least as old as required, they are eligible for GIS.”</p><p>If we were to run a trace on how this variable is calculated, we would see a tree that looks like this:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f92672>gis_eligible</span>:  
</span></span><span style=display:flex><span>  - <span style=color:#ae81ff>marital_status  </span>
</span></span><span style=display:flex><span>  - <span style=color:#ae81ff>partner_receiving_oas  </span>
</span></span><span style=display:flex><span>  - <span style=color:#ae81ff>income  </span>
</span></span><span style=display:flex><span>  - <span style=color:#ae81ff>age  </span>
</span></span><span style=display:flex><span>  - <span style=color:#ae81ff>oas_eligible</span>
</span></span></code></pre></div><p>That would be accurate, but it does not allow us to know whether <code>age</code> is still relevant when <code>oas_eligible</code> is false. That’s the kind of information we want to add to the output.</p><p>So what we are going to do is we are going to break this variable down into sub-variables, so as to get a tree that looks more like this:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f92672>gis_eligible</span>:  
</span></span><span style=display:flex><span>  - <span style=color:#f92672>income_is_eligible</span>:  
</span></span><span style=display:flex><span>    - <span style=color:#ae81ff>income  </span>
</span></span><span style=display:flex><span>    - <span style=color:#f92672>gis_eligible_income_max</span>:  
</span></span><span style=display:flex><span>      - <span style=color:#ae81ff>marital_status  </span>
</span></span><span style=display:flex><span>      - <span style=color:#ae81ff>partner_receiving_oas  </span>
</span></span><span style=display:flex><span>  - <span style=color:#f92672>age_eligible</span>:  
</span></span><span style=display:flex><span>    - <span style=color:#ae81ff>age  </span>
</span></span><span style=display:flex><span>  - <span style=color:#ae81ff>oas_eligible</span>
</span></span></code></pre></div><p>Now, if eligibility for GIS is not known, but we know that the income is eligible, we also know that we don’t have to ask about any of marital status, partner OAS, or income that have not already been collected. We also have the information required to be able to explain to the user why their maximum income was set at the level it was.</p><p>So where we had just gis_eligible, we now have four variables, encoded like this:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>gis_eligible</span>(Variable):  
</span></span><span style=display:flex><span>  value_type <span style=color:#f92672>=</span> bool  
</span></span><span style=display:flex><span>  entity <span style=color:#f92672>=</span> Person  
</span></span><span style=display:flex><span>  definition_period <span style=color:#f92672>=</span> DAY  
</span></span><span style=display:flex><span>  label <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;Whether Person is eligible for Guaranteed Income Supplement&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>formula</span>(person, period, parameters):  
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> person(<span style=color:#e6db74>&#39;oas_eligible&#39;</span>,period) <span style=color:#f92672>*</span> person(<span style=color:#e6db74>&#39;gis_eligible_income&#39;</span>,period) <span style=color:#f92672>*</span> person(<span style=color:#e6db74>&#39;gis_eligible_age&#39;</span>, period)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>gis_eligible_age</span>(Variable):  
</span></span><span style=display:flex><span>  value_type <span style=color:#f92672>=</span> bool  
</span></span><span style=display:flex><span>  entity <span style=color:#f92672>=</span> Person  
</span></span><span style=display:flex><span>  definition_period <span style=color:#f92672>=</span> DAY  
</span></span><span style=display:flex><span>  label <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;Whether the person&#39;s age meets the requirements for Guaranteed Income Supplement&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>formula</span>(person, period, parameters):  
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> person(<span style=color:#e6db74>&#34;age&#34;</span>,period) <span style=color:#f92672>&gt;=</span> parameters(period)<span style=color:#f92672>.</span>benefits<span style=color:#f92672>.</span>old_age_security<span style=color:#f92672>.</span>eligibility_age
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>gis_eligible_income</span>(Variable):  
</span></span><span style=display:flex><span>  value_type <span style=color:#f92672>=</span> bool  
</span></span><span style=display:flex><span>  entity <span style=color:#f92672>=</span> Person  
</span></span><span style=display:flex><span>  definition_period <span style=color:#f92672>=</span> DAY  
</span></span><span style=display:flex><span>  label <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;Whether the person&#39;s income meets the requirements for Guaranteed Income Supplement&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>formula</span>(person, period, parameters):  
</span></span><span style=display:flex><span>    income_requirement <span style=color:#f92672>=</span> person(<span style=color:#e6db74>&#34;income&#34;</span>,period<span style=color:#f92672>.</span>this_year) <span style=color:#f92672>&lt;</span> person(<span style=color:#e6db74>&#34;gis_eligible_income_max&#34;</span>, period)  
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>gis_eligible_income_max</span>(Variable):  
</span></span><span style=display:flex><span>  value_type <span style=color:#f92672>=</span> int  
</span></span><span style=display:flex><span>  entity <span style=color:#f92672>=</span> Person  
</span></span><span style=display:flex><span>  definition_period <span style=color:#f92672>=</span> DAY  
</span></span><span style=display:flex><span>  label <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;The person&#39;s maximum income for GIS eligibility&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>formula</span>(person, period, parameters):  
</span></span><span style=display:flex><span>    married <span style=color:#f92672>=</span> person(<span style=color:#e6db74>&#39;marital_status&#39;</span>,period) <span style=color:#f92672>==</span> marital_status_options<span style=color:#f92672>.</span>MARRIED  
</span></span><span style=display:flex><span>    common_law <span style=color:#f92672>=</span> person(<span style=color:#e6db74>&#39;marital_status&#39;</span>,period) <span style=color:#f92672>==</span> marital_status_options<span style=color:#f92672>.</span>COMMONLAW  
</span></span><span style=display:flex><span>    partnered <span style=color:#f92672>=</span> married <span style=color:#f92672>+</span> common_law  
</span></span><span style=display:flex><span>    max_single <span style=color:#f92672>=</span> parameters(period)<span style=color:#f92672>.</span>benefits<span style=color:#f92672>.</span>old_age_security<span style=color:#f92672>.</span>guaranteed_income_supplement<span style=color:#f92672>.</span>maximum_income_single  
</span></span><span style=display:flex><span>    max_partner <span style=color:#f92672>=</span> parameters(period)<span style=color:#f92672>.</span>benefits<span style=color:#f92672>.</span>old_age_security<span style=color:#f92672>.</span>guaranteed_income_supplement<span style=color:#f92672>.</span>maximum_income_partnered  
</span></span><span style=display:flex><span>    max_both <span style=color:#f92672>=</span> parameters(period)<span style=color:#f92672>.</span>benefits<span style=color:#f92672>.</span>old_age_security<span style=color:#f92672>.</span>guaranteed_income_supplement<span style=color:#f92672>.</span>maximum_income_two_recipients
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>max_income <span style=color:#f92672>=</span> where(partnered,max_partner,max_single)  
</span></span><span style=display:flex><span>    max_income <span style=color:#f92672>=</span> where(person(<span style=color:#e6db74>&#34;partner_receiving_oas&#34;</span>,period),max_both,max_income)  
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> max_income
</span></span></code></pre></div><p>That’s a lot more code to generate the exact same answer. But it still isn’t capable of dealing with whether or not the conclusions are known. So now we’re going to create four new variables, with the name <code>{original_variable_name}_known</code>, so that we will be able to relate them to each other. And the formula for each will set out the circumstances in which the value of the variable is certain.</p><p>For example, whether or not the person qualifies for GIS is now a conjunction of three things: they are eligible for oas, they meet the age requirement, and they meet the income requirement. A conjunction is known, whether true or false, if all of its parts are known. But a conjunction is also known to be false if any of its parts are known to be false. So we encode <code>gis_eligible_known</code> as follows:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>gis_eligible_known</span>(Variable):  
</span></span><span style=display:flex><span>  value_type <span style=color:#f92672>=</span> bool  
</span></span><span style=display:flex><span>  entity <span style=color:#f92672>=</span> Person  
</span></span><span style=display:flex><span>  definition_period <span style=color:#f92672>=</span> DAY  
</span></span><span style=display:flex><span>  label <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;Whether it is known if the Person is eligible for Guaranteed Income Supplement&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>formula</span>(person, period, parameters):  
</span></span><span style=display:flex><span>    all_known <span style=color:#f92672>=</span> person(<span style=color:#e6db74>&#39;oas_eligible_known&#39;</span>,period) <span style=color:#f92672>*</span> person(<span style=color:#e6db74>&#39;gis_eligible_income_known&#39;</span>, period) <span style=color:#f92672>*</span> person(<span style=color:#e6db74>&#39;gis_eligible_age_known&#39;</span>, period)  
</span></span><span style=display:flex><span>    oas_false <span style=color:#f92672>=</span> person(<span style=color:#e6db74>&#39;oas_eligible_known&#39;</span>,period) <span style=color:#f92672>*</span> not_(person(<span style=color:#e6db74>&#39;oas_eligible&#39;</span>,period))  
</span></span><span style=display:flex><span>    income_false <span style=color:#f92672>=</span> person(<span style=color:#e6db74>&#39;gis_eligible_income_known&#39;</span>, period) <span style=color:#f92672>*</span> not_(person(<span style=color:#e6db74>&#39;gis_eligible_income&#39;</span>, period))  
</span></span><span style=display:flex><span>    age_false <span style=color:#f92672>=</span> person(<span style=color:#e6db74>&#39;gis_eligible_age_known&#39;</span>, period) <span style=color:#f92672>*</span> person(<span style=color:#e6db74>&#39;gis_eligible_age&#39;</span>, period)  
</span></span><span style=display:flex><span>    any_false <span style=color:#f92672>=</span> oas_false <span style=color:#f92672>+</span> income_false <span style=color:#f92672>+</span> age_false
</span></span></code></pre></div><p>Now OpenFisca has a way of determining whether or not it knows the answer to GIS eligibility with certainty, and can explain why. But to make it work, we need to create the “known” variables for all of the other intermediate conclusions, and “known” variables for all of the inputs like age and income, too.</p><p>So in this example, the code goes from one variable to eight variables, not counting the increases for the input variables, and all of the math that goes into determining whether or not the person is eligible for OAS.</p><h3 id=output>Output</h3><p>If I run the code with an input where I provide only the person’s age, ask about GIS eligibility, and ask whether GIS eligibility is known, here is what the output looks like:</p><pre tabindex=0><code>  gis_eligible&lt;2021-12-08&gt; &gt;&gt; [ True]  
    oas_eligible&lt;2021-12-08&gt; &gt;&gt; [ True]  
    gis_eligible_income&lt;2021-12-08&gt; &gt;&gt; [ True]  
      income&lt;2021&gt; &gt;&gt; [0]  
      gis_eligible_income_max&lt;2021-12-08&gt; &gt;&gt; [18216]  
        gis_eligible_income_max_partnered&lt;2021-12-08&gt; &gt;&gt; [False]  
          marital_status&lt;2021-12-08&gt; &gt;&gt; [&#39;SINGLE&#39;]  
          marital_status&lt;2021-12-08&gt; &gt;&gt; [&#39;SINGLE&#39;]  
        partner_receiving_oas&lt;2021-12-08&gt; &gt;&gt; [False]  
    gis_eligible_age&lt;2021-12-08&gt; &gt;&gt; [ True]  
      age&lt;2021-12-08&gt; &gt;&gt; [75]

  gis_eligible_known&lt;2021-12-08&gt; &gt;&gt; [False]  
    oas_eligible_known&lt;2021-12-08&gt; &gt;&gt; [False]  
    gis_eligible_income_known&lt;2021-12-08&gt; &gt;&gt; [False]  
      income_known&lt;2021&gt; &gt;&gt; [False]  
      gis_eligible_income_max_known&lt;2021-12-08&gt; &gt;&gt; [ True]  
        gis_eligible_income_max_partnered&lt;2021-12-08&gt; &gt;&gt; [False]  
        gis_eligible_income_max_partnered_known&lt;2021-12-08&gt; &gt;&gt; [ True]  
          marital_status_known&lt;2021-12-08&gt; &gt;&gt; [ True]  
        marital_status_known&lt;2021-12-08&gt; &gt;&gt; [ True]  
        partner_receiving_oas_known&lt;2021-12-08&gt; &gt;&gt; [False]  
    gis_eligible_age_known&lt;2021-12-08&gt; &gt;&gt; [ True]  
      age_known&lt;2021-12-08&gt; &gt;&gt; [ True]  
    oas_eligible_known&lt;2021-12-08&gt; &gt;&gt; [False]  
    oas_eligible&lt;2021-12-08&gt; &gt;&gt; [ True]  
    gis_eligible_income_known&lt;2021-12-08&gt; &gt;&gt; [False]  
    gis_eligible_income&lt;2021-12-08&gt; &gt;&gt; [ True]  
    gis_eligible_age_known&lt;2021-12-08&gt; &gt;&gt; [ True]  
    gis_eligible_age&lt;2021-12-08&gt; &gt;&gt; [ True]
</code></pre><p>As a small aside, the output above is taken from the Python API, not the Web API. You would need to regenerate these trees from the data returned by the <code>/trace</code> endpoint when using the Web API.</p><p>The first tree shows how GIS eligibility was calculated. It shows that it determined that the person qualifies by virtue of being 75 years of age. Because a person’s income is presumed to be zero if not provided, they also qualify under the income requirement. Their maximum income was set to $18,216.</p><p>The second tree shows us the corresponding true/false values for whether or not the conclusions in the top tree are known. So we can check to see if “income_max”, which was set to $18,216, is actually known, and we can see that it is.</p><p>From the top tree we can see that it depends on whether the person is partnered, and whether the person’s partner is receiving OAS. From the bottom tree we can see that we know the person is not partnered, and that we do not know whether their partner is receiving OAS. But because whether their partner is receiving OAS is a dependency only of values in the top tree that are already known, we know it isn’t relevant for asking the question at the bottom of that tree.</p><p>The relevant questions to ask are the ones that are unknown, and are descendent only of unknown things above them in the dependency tree.</p><h3 id=take-aways>Take Aways</h3><p>This approach is deeply suboptimal, just because OpenFisca isn’t designed for powering expert systems. That’s not a critique of OpenFisca. A wrench makes a lousy hammer, and that’s not a critique of the design of wrenches.</p><p>But the approach shows that at least some of what you need can be achieved in OpenFisca. But the increase in the amount of boilerplate code you need to write is really high, and I think it’s reasonable to assume that it increases the risk of errors. It is also deeply non-standard, so tools that rely on understanding the implications of OpenFisca’s definition of a parameter and a variable may not be able to use this approach.</p><p>One benefit is that if you don’t need the “known” variables, you can run your calculations without them. So at that point the only thing slowing things down is having divided single variables into multiple variables.</p><p>OpenFisca could be made to support this sort of approach more easily. We could add features for uncertainty of variables, or syntactic sugar for making it easier to build complicated variable trees. You could also add endpoints to the Web API when what you need is the answer and the certainty, and the justification tree all at once, for example. We could also move some of what is currently post-processing into a different end point, and have OpenFisca return the lists of relevant variables, if it integrated this approach more fully.</p><p>I’m not sure any of that is actually worth it, though. It depends on how much effort it would take to get equivalent capabilities out of other approaches, and whether those other approaches might also be able to output something that could be turned into OpenFisca code, or code for some other microsimulation tool.</p><p>Getting microsimulation to work off of encodings of laws is an important objective. It remains to be seen whether that means OpenFisca code should be a starting place, or a destination.</p><ul class=pa0></ul><div class="mt6 instapaper_ignoref"></div></div><aside class="w-30-l mt6-l"><div class="bg-light-gray pa3 nested-list-reset nested-copy-line-height nested-links"><p class="f5 b mb3">What's in this post</p><nav id=TableOfContents><ul><li><ul><li><ul><li><a href=#the-plan>The Plan</a></li><li><a href=#some-caveats>Some Caveats</a><ul><li><a href=#structural-isomorpshim>Structural Isomorpshim</a></li><li><a href=#multiple-queries>Multiple Queries</a></li><li><a href=#post-processing>Post-Processing</a></li><li><a href=#style-dependent>Style Dependent</a></li></ul></li><li><a href=#an-example>An Example</a></li><li><a href=#output>Output</a></li><li><a href=#take-aways>Take Aways</a></li></ul></li></ul></li></ul></nav></div><div class="bg-light-gray pa3 nested-list-reset nested-copy-line-height nested-links"><p class="f5 b mb3">Related</p><ul class="pa0 list"><li class=mb2><a href=/post/roundtablelaw/openfisca-in-google-colab-de92e2621d88/>OpenFisca in Google Colab</a></li></ul></div></aside></article></main><footer class="bg-black bottom-0 w-100 pa3" role=contentinfo><div class="flex justify-between"><a class="f4 fw4 hover-white no-underline white-70 dn dib-ns pv2 ph3" href=https://JasonMorrisSC.github.io>&copy; Jason Morris 2022</a><div><div class=ananke-socials><a href=https://twitter.com/RoundTableLaw target=_blank class="twitter ananke-social-link link-transition stackoverflow link dib z-999 pt3 pt0-l mr1" title="Twitter link" rel=noopener aria-label="follow on Twitter——Opens in a new window"><span class=icon><svg style="enable-background:new 0 0 67 67" viewBox="0 0 67 67" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M37.167 22.283c-2.619.953-4.274 3.411-4.086 6.101l.063 1.038-1.048-.127c-3.813-.487-7.145-2.139-9.974-4.915l-1.383-1.377-.356 1.017c-.754 2.267-.272 4.661 1.299 6.271.838.89.649 1.017-.796.487-.503-.169-.943-.296-.985-.233-.146.149.356 2.076.754 2.839.545 1.06 1.655 2.097 2.871 2.712l1.027.487-1.215.021c-1.173.0-1.215.021-1.089.467.419 1.377 2.074 2.839 3.918 3.475l1.299.444-1.131.678c-1.676.976-3.646 1.526-5.616 1.568C19.775 43.256 19 43.341 19 43.405c0 .211 2.557 1.397 4.044 1.864 4.463 1.377 9.765.783 13.746-1.568 2.829-1.673 5.657-5 6.978-8.221.713-1.716 1.425-4.851 1.425-6.354.0-.975.063-1.102 1.236-2.267.692-.678 1.341-1.419 1.467-1.631.21-.403.188-.403-.88-.043-1.781.636-2.033.551-1.152-.402.649-.678 1.425-1.907 1.425-2.267.0-.063-.314.042-.671.233-.377.212-1.215.53-1.844.72l-1.131.361-1.027-.7c-.566-.381-1.361-.805-1.781-.932C39.766 21.902 38.131 21.944 37.167 22.283zM33 64C16.432 64 3 50.569 3 34S16.432 4 33 4s30 13.431 30 30S49.568 64 33 64z" style="fill-rule:evenodd;clip-rule:evenodd;fill:{{ .fill }}"/></svg></span><span class=new-window><svg height="8" style="enable-background:new 0 0 1000 1000" viewBox="0 0 1e3 1e3" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M598 128h298v298h-86V274L392 692l-60-60 418-418H598v-86zM810 810V512h86v298c0 46-40 86-86 86H214c-48 0-86-40-86-86V214c0-46 38-86 86-86h298v86H214v596h596z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg></span></a></div></div></div></footer></body></html>